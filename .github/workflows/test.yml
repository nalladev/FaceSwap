name: Test

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        echo "Available disk space before cleanup:"
        df -h
        # Remove unnecessary packages and files
        sudo apt-get clean
        sudo apt-get autoremove -y
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/lib/android /usr/share/swift
        docker system prune -af || true
        echo "Available disk space after cleanup:"
        df -h
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libgstreamer1.0-0 libgstreamer-plugins-base1.0-0
        # Clean package cache to save space
        sudo apt-get clean
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install with no cache dir to save space
        pip install --no-cache-dir setuptools wheel
        if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install --no-cache-dir -r requirements-dev.txt; fi
        echo "Available disk space after installation:"
        df -h
    
    - name: Run tests
      run: |
        python -m pytest -v --tb=short
