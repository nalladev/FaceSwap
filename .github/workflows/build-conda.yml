name: Build FaceSwap with Conda (Alternative)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0-conda'

jobs:
  build-linux-conda:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: 3.9
        channels: conda-forge,defaults
        channel-priority: flexible
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libx11-dev \
          libgtk-3-dev \
          libasound2-dev \
          libfontconfig1-dev \
          libfreetype6-dev \
          libx11-xcb-dev \
          libxext-dev \
          libxfixes-dev \
          libxi-dev \
          libxrender-dev \
          libxcb1-dev \
          libxcb-glx0-dev \
          libxcb-keysyms1-dev \
          libxcb-image0-dev \
          libxcb-shm0-dev \
          libxcb-icccm4-dev \
          libxcb-sync-dev \
          libxcb-xfixes0-dev \
          libxcb-shape0-dev \
          libxcb-randr0-dev \
          libxcb-render-util0-dev
          
    - name: Install Python dependencies with Conda
      shell: bash -l {0}
      run: |
        conda install -c conda-forge -y \
          dlib=19.24.2 \
          opencv=4.8.1 \
          numpy=1.24.3 \
          pillow=10.0.1
          
        pip install PySide6==6.6.0 pyinstaller
        
        python -c "import dlib; print(f'Dlib version: {dlib.__version__}')"
        python -c "import cv2; print(f'OpenCV version: {cv2.__version__}')"
        python -c "import PySide6; print('PySide6 imported successfully')"
        
    - name: Download model files
      shell: bash -l {0}
      run: |
        mkdir -p models
        cd models
        
        wget -q http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2
        bunzip2 shape_predictor_68_face_landmarks.dat.bz2
        
        wget -q http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2
        bunzip2 dlib_face_recognition_resnet_model_v1.dat.bz2
        
        ls -la
        echo "Models downloaded successfully"
        
    - name: Test application startup
      shell: bash -l {0}
      run: |
        python -c "
        import sys
        sys.path.append('.')
        from face_detector import FaceDetector
        from face_swapper import FaceSwapper
        print('✓ Core modules imported successfully')
        
        try:
            detector = FaceDetector()
            print('✓ Face detector initialized successfully')
        except Exception as e:
            print(f'✗ Face detector failed: {e}')
            sys.exit(1)
        "
        
    - name: Create executable with PyInstaller
      shell: bash -l {0}
      run: |
        CONDA_PREFIX=$(conda info --base)/envs/test
        if [ ! -d "$CONDA_PREFIX" ]; then
          CONDA_PREFIX=$CONDA_PREFIX
        fi
        
        pyinstaller --name="FaceSwap" \
          --onedir \
          --windowed \
          --add-data="models:models" \
          --add-data="gui:gui" \
          --add-data="utils:utils" \
          --add-data="requirements.txt:." \
          --add-data="README.md:." \
          --add-data="config.py:." \
          --hidden-import="PySide6" \
          --hidden-import="PySide6.QtCore" \
          --hidden-import="PySide6.QtGui" \
          --hidden-import="PySide6.QtWidgets" \
          --hidden-import="cv2" \
          --hidden-import="dlib" \
          --hidden-import="numpy" \
          --collect-all="PySide6" \
          --paths="$CONDA_PREFIX/lib/python3.9/site-packages" \
          main.py
          
        if [ -f "dist/FaceSwap/FaceSwap" ]; then
          echo "✓ Executable created successfully"
        else
          echo "✗ Executable creation failed"
          exit 1
        fi
          
    - name: Test executable
      shell: bash -l {0}
      run: |
        cd dist/FaceSwap
        timeout 10s ./FaceSwap --help || true
        echo "✓ Executable test completed"
        
    - name: Create Linux archive
      run: |
        cd dist
        cat > FaceSwap/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing FaceSwap..."
        sudo apt-get update
        sudo apt-get install -y libx11-6 libgtk-3-0 libasound2 libfontconfig1 libfreetype6
        echo "Installation complete. Run ./FaceSwap to start the application."
        EOF
        chmod +x FaceSwap/install.sh
        
        cat > FaceSwap/README.txt << 'EOF'
        FaceSwap - Local Face Swapping Tool (Conda Build)

        INSTALLATION:
        1. Run: ./install.sh (installs system dependencies)
        2. Run: ./FaceSwap (starts the application)

        SYSTEM REQUIREMENTS:
        - Ubuntu 18.04+ or compatible Linux distribution
        - 4GB RAM minimum, 8GB recommended
        - Multi-core CPU recommended

        TROUBLESHOOTING:
        - If the app won't start, run: ldd ./FaceSwap
        - Check for missing libraries and install with apt-get

        For support, visit: https://github.com/your-username/FaceSwap
        EOF
        
        tar -czf FaceSwap-Linux-x64-conda.tar.gz FaceSwap/
        
    - name: Upload Linux Conda artifact
      uses: actions/upload-artifact@v4
      with:
        name: FaceSwap-Linux-x64-conda
        path: dist/FaceSwap-Linux-x64-conda.tar.gz

  build-windows-conda:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: 3.9
        channels: conda-forge,defaults
        channel-priority: flexible
        
    - name: Install Python dependencies with Conda
      shell: bash -l {0}
      run: |
        conda install -c conda-forge -y \
          dlib=19.24.2 \
          opencv=4.8.1 \
          numpy=1.24.3 \
          pillow=10.0.1
          
        pip install PySide6==6.6.0 pyinstaller
        
        python -c "import dlib; print(f'Dlib version: {dlib.__version__}')"
        python -c "import cv2; print(f'OpenCV version: {cv2.__version__}')"
        python -c "import PySide6; print('PySide6 imported successfully')"
        
    - name: Download model files
      shell: bash -l {0}
      run: |
        mkdir -p models
        cd models
        
        curl -L -o shape_predictor_68_face_landmarks.dat.bz2 http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2
        curl -L -o dlib_face_recognition_resnet_model_v1.dat.bz2 http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2
        
        choco install 7zip -y
        "C:\Program Files\7-Zip\7z.exe" x "shape_predictor_68_face_landmarks.dat.bz2"
        "C:\Program Files\7-Zip\7z.exe" x "dlib_face_recognition_resnet_model_v1.dat.bz2"
        
        dir
        echo "Models downloaded and extracted successfully"
        
    - name: Create executable with PyInstaller
      shell: bash -l {0}
      run: |
        pyinstaller --name="FaceSwap" \
          --onedir \
          --windowed \
          --add-data="models;models" \
          --add-data="gui;gui" \
          --add-data="utils;utils" \
          --add-data="requirements.txt;." \
          --add-data="README.md;." \
          --add-data="config.py;." \
          --hidden-import="PySide6" \
          --hidden-import="PySide6.QtCore" \
          --hidden-import="PySide6.QtGui" \
          --hidden-import="PySide6.QtWidgets" \
          --hidden-import="cv2" \
          --hidden-import="dlib" \
          --hidden-import="numpy" \
          --collect-all="PySide6" \
          main.py
          
    - name: Create Windows archive
      run: |
        cd dist
        echo "FaceSwap - Local Face Swapping Tool (Conda Build)" > FaceSwap/README.txt
        echo "" >> FaceSwap/README.txt
        echo "USAGE:" >> FaceSwap/README.txt
        echo "1. Double-click FaceSwap.exe to start the application" >> FaceSwap/README.txt
        echo "2. No additional installation required" >> FaceSwap/README.txt
        echo "" >> FaceSwap/README.txt
        echo "SYSTEM REQUIREMENTS:" >> FaceSwap/README.txt
        echo "- Windows 10 or higher" >> FaceSwap/README.txt
        echo "- 4GB RAM minimum, 8GB recommended" >> FaceSwap/README.txt
        echo "- Multi-core CPU recommended" >> FaceSwap/README.txt
        echo "" >> FaceSwap/README.txt
        echo "For support, visit: https://github.com/your-username/FaceSwap" >> FaceSwap/README.txt
        
        Compress-Archive -Path "FaceSwap" -DestinationPath "FaceSwap-Windows-x64-conda.zip"
        
    - name: Upload Windows Conda artifact
      uses: actions/upload-artifact@v4
      with:
        name: FaceSwap-Windows-x64-conda
        path: dist/FaceSwap-Windows-x64-conda.zip

  create-conda-release:
    needs: [build-linux-conda, build-windows-conda]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version name
      id: version
      run: echo "VERSION_NAME=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Conda Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION_NAME }}
        name: FaceSwap ${{ steps.version.outputs.VERSION_NAME }} (Conda Build)
        draft: false
        prerelease: true
        body: |
          ## FaceSwap ${{ steps.version.outputs.VERSION_NAME }} - Conda Build
          
          ### Alternative Release Built with Conda
          
          This is an alternative release built using Conda package manager instead of pip.
          This version may be more stable on some systems due to pre-compiled packages.
          
          ### What's New
          - Built with Conda for better dependency management
          - Pre-compiled dlib package (no compilation required)
          - More stable on various Linux distributions
          - All dependencies bundled and tested
          
          ### Installation
          
          #### Windows (Conda Build)
          1. Download `FaceSwap-Windows-x64-conda.zip`
          2. Extract the archive
          3. Run `FaceSwap.exe`
          
          #### Linux (Conda Build)
          1. Download `FaceSwap-Linux-x64-conda.tar.gz`
          2. Extract: `tar -xzf FaceSwap-Linux-x64-conda.tar.gz`
          3. Install dependencies: `./FaceSwap/install.sh`
          4. Run: `./FaceSwap/FaceSwap`
          
          ### System Requirements
          - **OS**: Windows 10+, Ubuntu 18.04+
          - **RAM**: 4GB minimum, 8GB recommended
          - **CPU**: Multi-core processor recommended
          - **Storage**: 2GB free space
          
          ### Differences from Regular Build
          - Uses Conda-packaged dependencies instead of pip
          - May work better on systems where dlib compilation fails
          - Slightly larger download size due to additional libraries
          - More compatible across different Linux distributions
          
          ### Notes
          - This is a pre-release build for testing
          - If you encounter issues, try the regular pip-based release
          - All functionality is identical to the main release
          
          ---
          **Built with**: Conda + PyInstaller  
          **Dependencies**: dlib (conda-forge), OpenCV (conda-forge), PySide6 (pip)
        files: |
          ./FaceSwap-Linux-x64-conda/FaceSwap-Linux-x64-conda.tar.gz
          ./FaceSwap-Windows-x64-conda/FaceSwap-Windows-x64-conda.zip