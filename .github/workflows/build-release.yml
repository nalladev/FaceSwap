name: Build and Release FaceSwap

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  discussions: write

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libopenblas-dev \
          liblapack-dev \
          libx11-dev \
          libgtk-3-dev \
          python3-dev \
          libboost-all-dev \
          libavcodec-dev \
          libavformat-dev \
          libswscale-dev \
          libv4l-dev \
          libxvidcore-dev \
          libx264-dev \
          libjpeg-dev \
          libpng-dev \
          libtiff-dev \
          gfortran \
          pkg-config \
          libdlib-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools

        pip install numpy==1.24.3 Pillow==10.0.1

        echo "=== Installing dlib with system libraries ==="
        export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH
        pip install dlib==19.24.2 --no-build-isolation --no-cache-dir

        pip install opencv-python==4.8.1.78 PySide6==6.6.0
        pip install pyinstaller

        python -c "import dlib; print(f'✓ Dlib {dlib.__version__} imported successfully')"

    - name: Download model files
      run: |
        mkdir -p models
        cd models

        wget -q http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2
        bunzip2 shape_predictor_68_face_landmarks.dat.bz2

        wget -q http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2
        bunzip2 dlib_face_recognition_resnet_model_v1.dat.bz2

        ls -la

    - name: Create executable with PyInstaller
      run: |
        python -c "
        import sys, traceback
        try:
            import dlib
            import cv2
            import numpy as np
            from PySide6 import QtCore, QtGui, QtWidgets
            print('✓ All imports successful')
        except Exception as e:
            print(f'✗ Import failed: {e}')
            traceback.print_exc()
            sys.exit(1)
        "

        pyinstaller --name="FaceSwap" \
          --onedir \
          --windowed \
          --add-data="models:models" \
          --add-data="gui:gui" \
          --add-data="utils:utils" \
          --add-data="requirements.txt:." \
          --add-data="README.md:." \
          --add-data="config.py:." \
          --hidden-import="PySide6" \
          --hidden-import="PySide6.QtCore" \
          --hidden-import="PySide6.QtGui" \
          --hidden-import="PySide6.QtWidgets" \
          --hidden-import="cv2" \
          --hidden-import="dlib" \
          --hidden-import="numpy" \
          --collect-all="PySide6" \
          --noconfirm \
          main.py

        if [ -f "dist/FaceSwap/FaceSwap" ]; then
          echo "✓ Executable created successfully"
          ls -la dist/FaceSwap/
        else
          echo "✗ Executable creation failed"
          ls -la dist/
          exit 1
        fi

    - name: Create Linux archive
      run: |
        cd dist
        tar -czf FaceSwap-Linux-x64.tar.gz FaceSwap/

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: FaceSwap-Linux-x64
        path: dist/FaceSwap-Linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Download model files
      run: |
        mkdir models
        cd models

        Invoke-WebRequest -Uri "http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2" -OutFile "shape_predictor_68_face_landmarks.dat.bz2"
        Invoke-WebRequest -Uri "http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2" -OutFile "dlib_face_recognition_resnet_model_v1.dat.bz2"

    - name: Install 7-Zip
      run: |
        choco install 7zip -y

    - name: Extract model files
      run: |
        cd models
        & "C:\Program Files\7-Zip\7z.exe" x "shape_predictor_68_face_landmarks.dat.bz2"
        & "C:\Program Files\7-Zip\7z.exe" x "dlib_face_recognition_resnet_model_v1.dat.bz2"
        dir

    - name: Create executable with PyInstaller
      run: |
        pyinstaller --name="FaceSwap" `
          --onedir `
          --windowed `
          --add-data="models;models" `
          --add-data="gui;gui" `
          --add-data="utils;utils" `
          --add-data="requirements.txt;." `
          --add-data="README.md;." `
          --add-data="config.py;." `
          --hidden-import="PySide6" `
          --hidden-import="cv2" `
          --hidden-import="dlib" `
          --hidden-import="numpy" `
          --collect-all="PySide6" `
          main.py

    - name: Create Windows archive
      run: |
        cd dist
        Compress-Archive -Path "FaceSwap" -DestinationPath "FaceSwap-Windows-x64.zip"

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: FaceSwap-Windows-x64
        path: dist/FaceSwap-Windows-x64.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get tag name
      id: tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "TAG_NAME=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: FaceSwap ${{ steps.tag.outputs.TAG_NAME }}
        draft: false
        prerelease: false
        body: |
          ## FaceSwap ${{ steps.tag.outputs.TAG_NAME }}

          ### What's New in This Release
          - **Enhanced Documentation**: Updated README with accurate repository URLs and improved installation instructions
          - **Streamlined CI/CD**: Improved GitHub Actions workflow for reliable cross-platform builds
          - **Robust Build System**: Enhanced PyInstaller configuration with proper dependency bundling
          - **Better Error Handling**: Improved import validation and dependency checking during builds
          - **Updated Dependencies**: 
            - Python 3.9 runtime
            - OpenCV 4.8.1.78 for video processing
            - Dlib 19.24.2 for face detection and recognition
            - PySide6 6.6.0 for modern GUI
            - NumPy 1.24.3 and Pillow 10.0.1 for image processing

          ### Features
          - **100% Local Processing**: No cloud dependencies - everything runs on your machine
          - **Automatic Face Detection**: Advanced face detection and clustering using Dlib
          - **Intuitive GUI**: Modern interface built with PySide6/Qt
          - **High-Quality Results**: Seamless face swapping with Poisson blending
          - **Cross-Platform**: Windows and Linux executables included
          - **Multiple Format Support**: Works with MP4, AVI, MOV, MKV and other video formats

          ### Installation

          #### Windows
          1. Download `FaceSwap-Windows-x64.zip`
          2. Extract the archive to any folder
          3. Run `FaceSwap.exe`
          4. **No Python installation required!**

          #### Linux
          1. Download `FaceSwap-Linux-x64.tar.gz`
          2. Extract: `tar -xzf FaceSwap-Linux-x64.tar.gz`
          3. Make executable: `chmod +x FaceSwap/FaceSwap`
          4. Run: `./FaceSwap/FaceSwap`

          ### System Requirements
          - **OS**: Windows 10+ or Ubuntu 18.04+
          - **RAM**: 4GB minimum, 8GB recommended for large videos
          - **CPU**: Multi-core processor recommended for faster processing
          - **Storage**: 2GB free space for application and models
          - **GPU**: Not required - uses CPU-only processing

          ### Quick Start Guide
          1. **Launch** FaceSwap application
          2. **Select Video**: Choose your input video file
          3. **Scan for Faces**: Detect and group unique faces (may take a few minutes)
          4. **Assign Swap Images**: Select replacement face images for detected faces
          5. **Process Video**: Generate your face-swapped video
          6. **Results**: Find output video in `~/Videos/faceswap_output.mp4`

          ### Performance Tips
          - **Video Length**: 1-minute 1080p videos take ~5-15 minutes to process
          - **Memory**: Close other applications during processing for best performance  
          - **Quality**: Use high-resolution, well-lit source images for better results
          - **Speed**: Lower resolution videos process faster

          ### Technical Details
          - **Face Detection**: Uses Dlib's 68-point facial landmark detection
          - **Face Recognition**: 128-dimensional face embeddings for grouping
          - **Blending**: OpenCV's Poisson seamless cloning for natural results
          - **Architecture**: Modular design with separate detection, swapping, and GUI components

          ### Known Issues & Limitations
          - First run may be slower as models load into memory
          - Processing time scales with video length and resolution
          - Works best with clear, front-facing faces in good lighting
          - Large videos (>10 minutes) may require significant processing time

          ### Development & Source Code
          - **Repository**: https://github.com/ZacharyJoyner/faceswap
          - **Installation**: `pip install -r requirements.txt` after cloning
          - **Models**: Automatically downloaded on first run or manually via provided script
          - **Contributing**: Pull requests and issues welcome!

          ### Security & Privacy
          - **Local Processing**: Your videos never leave your computer
          - **No Telemetry**: No data collection or internet connectivity required after download
          - **Open Source**: Full source code available for audit and modification

          ---
          **⚠️ Ethical Use Disclaimer**: This tool is for educational, creative, and entertainment purposes. Always obtain consent before processing videos containing other people. Users are responsible for complying with applicable laws and using this tool ethically.

          **Full Changelog**: https://github.com/ZacharyJoyner/faceswap/compare/v${{ steps.tag.outputs.TAG_NAME }}...v${{ steps.tag.outputs.TAG_NAME }}
        files: |
          ./FaceSwap-Linux-x64/FaceSwap-Linux-x64.tar.gz
          ./FaceSwap-Windows-x64/FaceSwap-Windows-x64.zip
