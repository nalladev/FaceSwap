name: Build and Release FaceSwap

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0-manual'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libopenblas-dev \
          liblapack-dev \
          libx11-dev \
          libgtk-3-dev \
          python3-dev \
          libboost-all-dev \
          libavcodec-dev \
          libavformat-dev \
          libswscale-dev \
          libv4l-dev \
          libxvidcore-dev \
          libx264-dev \
          libjpeg-dev \
          libpng-dev \
          libtiff-dev \
          gfortran \
          pkg-config \
          libdlib-dev
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        
        # Install non-problematic packages first
        pip install numpy==1.24.3 Pillow==10.0.1
        
        # Try to install dlib with comprehensive fallback strategy
        echo "=== Installing dlib with fallback strategies ==="
        
        # Method 1: Try pre-built wheel from PyPI
        echo "Method 1: Trying pre-built wheel from PyPI..."
        if pip install dlib==19.24.2 --only-binary=dlib --no-cache-dir 2>/dev/null; then
          echo "✓ SUCCESS: Dlib installed from PyPI pre-built wheel"
          DLIB_INSTALLED=true
        else
          echo "✗ FAILED: No pre-built wheel available on PyPI"
          DLIB_INSTALLED=false
        fi
        
        # Method 2: Try conda-forge wheel
        if [ "$DLIB_INSTALLED" = false ]; then
          echo "Method 2: Trying conda-forge wheel..."
          if pip install --extra-index-url https://pypi.anaconda.org/conda-forge/simple dlib==19.24.2 --only-binary=dlib 2>/dev/null; then
            echo "✓ SUCCESS: Dlib installed from conda-forge wheel"
            DLIB_INSTALLED=true
          else
            echo "✗ FAILED: conda-forge wheel installation failed"
          fi
        fi
        
        # Method 3: Try specific known working wheel
        if [ "$DLIB_INSTALLED" = false ]; then
          echo "Method 3: Trying specific known wheel..."
          if pip install https://files.pythonhosted.org/packages/0e/ce/f8a3cff33ac03a8219768f0694c5d703c8e037e6aba2e865f9bae22ed63c/dlib-19.24.2-cp39-cp39-linux_x86_64.whl 2>/dev/null; then
            echo "✓ SUCCESS: Dlib installed from specific wheel"  
            DLIB_INSTALLED=true
          else
            echo "✗ FAILED: Specific wheel installation failed"
          fi
        fi
        
        # Method 4: Build with system libraries
        if [ "$DLIB_INSTALLED" = false ]; then
          echo "Method 4: Building with system dlib libraries..."
          export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH
          if pip install dlib==19.24.2 --no-build-isolation --no-cache-dir 2>/dev/null; then
            echo "✓ SUCCESS: Dlib built with system libraries"
            DLIB_INSTALLED=true
          else
            echo "✗ FAILED: System library build failed"
          fi
        fi
        
        # Method 5: Last resort - build from source with all optimizations disabled
        if [ "$DLIB_INSTALLED" = false ]; then
          echo "Method 5: Last resort - minimal build from source..."
          pip install cmake==3.29.0
          export CMAKE_ARGS="-DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DDLIB_NO_GUI_SUPPORT=ON -DDLIB_USE_CUDA=OFF -DDLIB_USE_BLAS=OFF -DDLIB_USE_LAPACK=OFF"
          export MAKEFLAGS="-j1"  # Single threaded to avoid memory issues
          if pip install dlib==19.24.0 --no-cache-dir --verbose; then
            echo "✓ SUCCESS: Dlib built from source (minimal)"
            DLIB_INSTALLED=true
          else
            echo "✗ CRITICAL FAILURE: All dlib installation methods failed"
            exit 1
          fi
        fi
        
        # Install remaining packages
        pip install opencv-python==4.8.1.78 PySide6==6.6.0
        pip install pyinstaller
        
        # Verify installation
        python -c "import dlib; print(f'✓ Dlib {dlib.__version__} imported successfully')"
        
    - name: Download model files
      run: |
        mkdir -p models
        cd models
        
        # Download facial landmarks model
        wget -q http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2
        bunzip2 shape_predictor_68_face_landmarks.dat.bz2
        
        # Download face recognition model
        wget -q http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2
        bunzip2 dlib_face_recognition_resnet_model_v1.dat.bz2
        
        # Verify files exist
        ls -la
        
    - name: Create executable with PyInstaller
      run: |
        # Verify all imports work before building
        python -c "
import sys, traceback
try:
    import dlib
    import cv2
    import numpy as np
    from PySide6 import QtCore, QtGui, QtWidgets
    print('✓ All imports successful')
except Exception as e:
    print(f'✗ Import failed: {e}')
    traceback.print_exc()
    sys.exit(1)
"
        
        pyinstaller --name="FaceSwap" \
          --onedir \
          --windowed \
          --add-data="models:models" \
          --add-data="gui:gui" \
          --add-data="utils:utils" \
          --add-data="requirements.txt:." \
          --add-data="README.md:." \
          --add-data="config.py:." \
          --hidden-import="PySide6" \
          --hidden-import="PySide6.QtCore" \
          --hidden-import="PySide6.QtGui" \
          --hidden-import="PySide6.QtWidgets" \
          --hidden-import="cv2" \
          --hidden-import="dlib" \
          --hidden-import="numpy" \
          --collect-all="PySide6" \
          --noconfirm \
          main.py
          
        # Verify the executable was created
        if [ -f "dist/FaceSwap/FaceSwap" ]; then
          echo "✓ Executable created successfully"
          ls -la dist/FaceSwap/
        else
          echo "✗ Executable creation failed"
          ls -la dist/
          exit 1
        fi
          
    - name: Create Linux archive
      run: |
        cd dist
        tar -czf FaceSwap-Linux-x64.tar.gz FaceSwap/
        
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: FaceSwap-Linux-x64
        path: dist/FaceSwap-Linux-x64.tar.gz

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Download model files
      run: |
        mkdir models
        cd models
        
        # Download facial landmarks model
        Invoke-WebRequest -Uri "http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2" -OutFile "shape_predictor_68_face_landmarks.dat.bz2"
        
        # Download face recognition model  
        Invoke-WebRequest -Uri "http://dlib.net/files/dlib_face_recognition_resnet_model_v1.dat.bz2" -OutFile "dlib_face_recognition_resnet_model_v1.dat.bz2"
        
        # Extract files (Windows doesn't have bunzip2, so we'll include compressed files and extract at runtime)
        # For now, let's use a workaround with 7-zip
        
    - name: Install 7-Zip
      run: |
        choco install 7zip -y
        
    - name: Extract model files
      run: |
        cd models
        & "C:\Program Files\7-Zip\7z.exe" x "shape_predictor_68_face_landmarks.dat.bz2"
        & "C:\Program Files\7-Zip\7z.exe" x "dlib_face_recognition_resnet_model_v1.dat.bz2"
        dir
        
    - name: Create executable with PyInstaller
      run: |
        pyinstaller --name="FaceSwap" `
          --onedir `
          --windowed `
          --add-data="models;models" `
          --add-data="gui;gui" `
          --add-data="utils;utils" `
          --add-data="requirements.txt;." `
          --add-data="README.md;." `
          --add-data="config.py;." `
          --hidden-import="PySide6" `
          --hidden-import="cv2" `
          --hidden-import="dlib" `
          --hidden-import="numpy" `
          --collect-all="PySide6" `
          main.py
          
    - name: Create Windows archive
      run: |
        cd dist
        Compress-Archive -Path "FaceSwap" -DestinationPath "FaceSwap-Windows-x64.zip"
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: FaceSwap-Windows-x64
        path: dist/FaceSwap-Windows-x64.zip

  # Temporarily disabled macOS build
  # build-macos:
  #   runs-on: macos-latest

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get tag name
      id: tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "TAG_NAME=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.TAG_NAME }}
        name: FaceSwap ${{ steps.tag.outputs.TAG_NAME }}
        draft: false
        prerelease: false
        body: |
          ## FaceSwap ${{ steps.tag.outputs.TAG_NAME }}
          
          ### What's New
          - Local face swapping with advanced computer vision
          - No cloud dependencies - everything runs on your machine
          - Intuitive GUI built with PySide6
          - High-quality results using Poisson blending
          - Support for multiple video formats
          
          ### Installation
          
          #### Windows
          1. Download `FaceSwap-Windows-x64.zip`
          2. Extract the archive
          3. Run `FaceSwap.exe`
          
          #### Linux
          1. Download `FaceSwap-Linux-x64.tar.gz`
          2. Extract: `tar -xzf FaceSwap-Linux-x64.tar.gz`
          3. Run: `./FaceSwap/FaceSwap`
          
          #### macOS
          1. Download `FaceSwap-macOS-x64.tar.gz`
          2. Extract: `tar -xzf FaceSwap-macOS-x64.tar.gz`
          3. Run: `./FaceSwap/FaceSwap`
          
          ### System Requirements
          - **OS**: Windows 10+, Ubuntu 18.04+, or macOS 10.14+
          - **RAM**: 4GB minimum, 8GB recommended
          - **CPU**: Multi-core processor recommended
          - **Storage**: 2GB free space
          
          ### Usage
          1. Select a video file
          2. Scan for faces (this may take a few minutes)
          3. Assign swap images to detected faces
          4. Process the video
          5. Find your swapped video in ~/Videos/
          
          ### Notes
          - First run may take longer as models are loaded
          - Processing time depends on video length and resolution
          - For best results, use high-quality source images with clear faces
          - The tool works entirely offline - no internet required after download
          
          ### Troubleshooting
          - If you encounter issues, check the log file in the application directory
          - Ensure your system meets the minimum requirements
          - Try reducing video resolution for faster processing
          
          ---
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.tag.outputs.TAG_NAME }}...v${{ steps.tag.outputs.TAG_NAME }}
          
        files: |
          ./FaceSwap-Linux-x64/FaceSwap-Linux-x64.tar.gz
          ./FaceSwap-Windows-x64/FaceSwap-Windows-x64.zip